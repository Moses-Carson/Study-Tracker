<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Study Tracker — Customizable (GitHub-ready)</title>

<!-- Google Fonts -->
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@600;700&family=Inter:wght@300;400;600&display=swap" rel="stylesheet">

<!-- ====== Add your Google Analytics snippet here (paste before </head>) ======
<script async src="https://www.googletagmanager.com/gtag/js?id=YOUR_GA_ID"></script>
<script>
 window.dataLayer = window.dataLayer || [];
 function gtag(){dataLayer.push(arguments);}
 gtag('js', new Date());
 gtag('config', 'YOUR_GA_ID');
</script>
=========================================================================== -->

<style>
  :root{
    --blue:#0d47a1;
    --blue-2:#1e88e5;
    --black:#071426;
    --white:#ffffff;
    --muted: rgba(255,255,255,0.85);
    --glass: rgba(255,255,255,0.06);
    --accent:#22c55e;
    --danger:#ff6b6b;
  }
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;font-family:Inter,system-ui,Arial;background:#0b2340;color:var(--muted)}
  /* background */
  .bg {
    position:fixed;inset:0;z-index:-10;display:flex;align-items:center;justify-content:center;overflow:hidden;
  }
  .bg img{position:absolute;inset:0;width:100%;height:100%;object-fit:cover;filter:grayscale(6%) brightness(0.55) saturate(105%);transition:opacity .9s ease}
  .bg .overlay{position:absolute;inset:0;background:linear-gradient(180deg, rgba(10,25,50,0.55), rgba(5,10,25,0.75));pointer-events:none}
  /* container */
  .wrap{max-width:1100px;margin:28px auto;padding:22px;display:flex;flex-direction:column;gap:18px}
  header{display:flex;align-items:center;justify-content:space-between;gap:12px}
  .brand{display:flex;align-items:center;gap:12px}
  .brand .logo{
    width:56px;height:56px;border-radius:12px;background:linear-gradient(135deg,var(--blue),var(--blue-2));
    display:flex;align-items:center;justify-content:center;font-weight:700;color:white;font-family:Poppins
  }
  h1{margin:0;color:white;font-family:Poppins;font-size:20px}
  /* card */
  .card{background:var(--glass);border-radius:14px;padding:14px;backdrop-filter: blur(6px);box-shadow:0 8px 30px rgba(3,10,25,0.45)}
  /* layout */
  .grid{display:grid;grid-template-columns:1fr 360px;gap:16px}
  /* login */
  .login-card{display:flex;gap:12px;align-items:center;justify-content:space-between;flex-wrap:wrap}
  .form{display:flex;flex-direction:column;gap:8px;min-width:260px}
  .form input, .form textarea, .form select{
    padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.07);background:rgba(255,255,255,0.04);color:white;outline:none
  }
  .btn{padding:10px 12px;border-radius:10px;border:none;background:linear-gradient(90deg,var(--blue),var(--blue-2));color:white;font-weight:600;cursor:pointer}
  .btn.ghost{background:transparent;border:1px solid rgba(255,255,255,0.08)}
  .muted{color:rgba(255,255,255,0.8);font-size:13px}
  /* dashboard */
  .welcome-row{display:flex;justify-content:space-between;align-items:center;gap:12px}
  .stats{display:flex;gap:12px;flex-wrap:wrap;margin-top:12px}
  .stat{min-width:110px;background:linear-gradient(180deg, rgba(255,255,255,0.03), rgba(255,255,255,0.02));padding:12px;border-radius:10px;text-align:center}
  .stat .big{font-size:20px;font-weight:700;color:white}
  .progress{margin-top:12px}
  .progress-bar{height:18px;background:rgba(255,255,255,0.08);border-radius:999px;overflow:hidden}
  .progress-fill{height:18px;background:linear-gradient(90deg,var(--blue), #66bbff);width:0%;display:flex;align-items:center;justify-content:center;color:#012; font-weight:700;}
  /* topics */
  .topics{margin-top:12px}
  .topic{display:flex;align-items:center;gap:12px;padding:10px;border-radius:10px;margin-bottom:8px;background:rgba(255,255,255,0.03)}
  .topic input[type=checkbox]{transform:scale(1.2)}
  .topic .title{flex:1}
  .topic .actions{display:flex;gap:8px}
  .small{font-size:13px}
  .tools{display:flex;gap:8px;flex-wrap:wrap}
  /* right column */
  aside .card{position:sticky;top:24px}
  .bg-controls{display:flex;gap:8px;align-items:center;margin-top:8px}
  .bg-preview{height:80px;border-radius:8px;overflow:hidden}
  .bg-preview img{width:100%;height:100%;object-fit:cover;display:block}
  /* responsive */
  @media (max-width:980px){
    .grid{grid-template-columns:1fr}
    aside .card{position:static}
  }
</style>
</head>
<body>
  <div class="bg" id="bg">
    <!-- background images will be injected here -->
    <div class="overlay"></div>
  </div>

  <div class="wrap" id="app">
    <header>
      <div class="brand">
        <div class="logo">ST</div>
        <div>
          <h1>Study Tracker</h1>
          <div class="muted small">Customizable • Share-ready • Beautiful UI</div>
        </div>
      </div>
      <div style="display:flex;gap:8px;align-items:center">
        <div id="userBrief" class="muted small">Not signed in</div>
        <button id="logoutBtn" class="btn ghost" style="display:none">Logout</button>
      </div>
    </header>

    <!-- LOGIN VIEW -->
    <div id="loginView" class="card">
      <div style="display:flex;gap:12px;align-items:center;justify-content:space-between;flex-wrap:wrap">
        <div style="min-width:200px">
          <h2 style="margin:0;color:white;font-family:Poppins">Sign up / Sign in</h2>
          <div class="muted small">Create a local account (works offline). We'll switch to Firebase later.</div>
        </div>

        <div class="form" style="min-width:320px">
          <input id="nameIn" type="text" placeholder="Full name (e.g. Moses Carson)" value="Moses Carson" />
          <input id="emailIn" type="email" placeholder="Email (example: you@school.edu)" />
          <input id="deptIn" type="text" placeholder="Department (e.g. MLS)" />
          <div style="display:flex;gap:8px">
            <button id="signupBtn" class="btn">Sign Up</button>
            <button id="signinBtn" class="btn ghost">Sign In</button>
          </div>
          <div style="display:flex;gap:8px;margin-top:8px">
            <button id="guestBtn" class="btn ghost">Continue as Guest</button>
            <button id="demoBtn" class="btn ghost">Demo with Example Data</button>
          </div>
        </div>
      </div>
    </div>

    <!-- DASHBOARD -->
    <div id="dashView" style="display:none">
      <div class="grid">
        <main>
          <div class="card">
            <div class="welcome-row">
              <div>
                <div class="muted small">Welcome</div>
                <div style="font-weight:700;font-size:18px" id="welcomeName">Student</div>
                <div class="muted small" id="welcomeDept">Department</div>
              </div>
              <div style="text-align:right">
                <div class="muted small">Plan</div>
                <div class="small" style="display:flex;gap:6px;align-items:center">
                  <input id="startDate" type="date" style="padding:8px;border-radius:8px;background:rgba(255,255,255,0.03);border:1px solid rgba(255,255,255,0.06);color:white" />
                  <input id="durationDays" type="number" min="1" value="30" style="width:80px;padding:8px;border-radius:8px;background:rgba(255,255,255,0.03);border:1px solid rgba(255,255,255,0.06);color:white" />
                  <button id="savePlan" class="btn ghost">Save</button>
                </div>
              </div>
            </div>

            <div class="stats" style="margin-top:12px">
              <div class="stat">
                <div class="muted small">Progress</div>
                <div class="big" id="percentLarge">0%</div>
              </div>
              <div class="stat">
                <div class="muted small">Completed</div>
                <div class="big" id="completedCount">0</div>
              </div>
              <div class="stat">
                <div class="muted small">Remaining</div>
                <div class="big" id="remainingCount">0</div>
              </div>
              <div class="stat">
                <div class="muted small">Daily target</div>
                <div class="big" id="dailyTarget">0</div>
              </div>
            </div>

            <div class="progress">
              <div class="progress-bar">
                <div class="progress-fill" id="progressFill">0%</div>
              </div>
            </div>

            <div style="margin-top:12px;display:flex;gap:8px;align-items:center;flex-wrap:wrap">
              <button id="addTopic" class="btn ghost">+ Add Topic</button>
              <button id="editTopics" class="btn ghost">Edit topics</button>
              <button id="download" class="btn ghost">Download progress</button>
              <button id="restore" class="btn ghost">Restore from file</button>
              <button id="resetAll" class="btn" style="background:var(--danger)">Reset All Progress</button>
            </div>
          </div>

          <div class="card topics" id="topicsCard">
            <div style="display:flex;justify-content:space-between;align-items:center">
              <div style="font-weight:700">Your Topics</div>
              <div class="small muted">Click a topic to toggle complete</div>
            </div>
            <div id="topicsList" style="margin-top:12px;min-height:90px"></div>
          </div>

        </main>

        <aside>
          <div class="card">
            <div style="display:flex;justify-content:space-between;align-items:center">
              <div style="font-weight:700">Backgrounds</div>
              <div class="small muted">rotate daily or manual</div>
            </div>

            <div class="bg-controls" style="margin-top:10px">
              <button id="prevBg" class="btn ghost">◀</button>
              <button id="nextBg" class="btn ghost">▶</button>
              <button id="addBg" class="btn ghost">Add</button>
            </div>

            <div style="margin-top:12px">
              <div class="small muted">Current list (you can paste image URLs)</div>
              <div id="bgList" style="margin-top:8px"></div>
            </div>

            <div style="margin-top:12px">
              <div class="small muted">Preview</div>
              <div class="bg-preview" id="bgPreview" style="margin-top:8px"></div>
            </div>

            <div style="margin-top:12px">
              <div class="small muted">Share & Usage</div>
              <div style="display:flex;gap:8px;margin-top:8px">
                <button id="copyLink" class="btn ghost">Copy Page Link</button>
                <button id="deployGuide" class="btn ghost">Deploy Guide</button>
              </div>
            </div>
          </div>
        </aside>
      </div>

      <div style="margin-top:12px;text-align:center;color:rgba(255,255,255,0.75);font-size:13px">Hosted locally — upload to GitHub Pages to share. Analytics placeholder in head.</div>
    </div>

  </div>

<script>
/* ==========================
   Local App Storage Keys
   ========================== */
const KEY_USER = 'st_user_v1';
const KEY_TOPICS = 'st_topics_v1';
const KEY_PLAN = 'st_plan_v1';
const KEY_BG = 'st_bg_v1';

/* ==========================
   Default backgrounds (login vs dashboard)
   These are royalty-free photos from Unsplash (hotlinking permitted).
   You can replace or add custom image URLs via the UI.
   ========================== */
const DEFAULT_BGS = [
  // login backgrounds
  [
    'https://images.unsplash.com/photo-1503676260728-1c00da094a0b?q=80&w=1600&auto=format&fit=crop&ixlib=rb-4.0.3&s=bb91d5d8e1e0b0a3f6a4f1a7a6c29f86',
    'https://images.unsplash.com/photo-1514512364185-4a0d2a7a0bdf?q=80&w=1600&auto=format&fit=crop&ixlib=rb-4.0.3&s=0f9e8a7aef8b3e4f5f7e0d1a9fc5a5ab'
  ],
  // dashboard backgrounds
  [
    'https://images.unsplash.com/photo-1523240795612-9a054b0db644?q=80&w=1600&auto=format&fit=crop&ixlib=rb-4.0.3&s=8fb4b9cbe1d3a1602da3a7f2c4b9fe98',
    'https://images.unsplash.com/photo-1516979187457-637abb4f9353?q=80&w=1600&auto=format&fit=crop&ixlib=rb-4.0.3&s=5c1e1f9f5f1d4b2b8d2e0d3a2b2c4f6f'
  ]
];

/* ==========================
   App state
   ========================== */
let state = {
  user: null,
  topics: [], // array of {title, done}
  plan: { startDate: null, durationDays: 30 },
  bgLists: { login: [], dash: [] },
  pageBgIndex: 0,
  pageType: 'login' // login or dash
};

/* --------------------------
   Utilities
   -------------------------- */
const $ = id => document.getElementById(id);
const saveJSON = (k,v) => localStorage.setItem(k, JSON.stringify(v));
const loadJSON = (k, fallback) => {
  try { const s = localStorage.getItem(k); return s ? JSON.parse(s) : fallback; } catch(e){ return fallback; }
};

/* --------------------------
   Initialize defaults
   -------------------------- */
function initDefaults(){
  // user
  const user = loadJSON(KEY_USER, null);
  if(user){ state.user = user; }
  // topics
  const topics = loadJSON(KEY_TOPICS, null);
  if(topics){ state.topics = topics; } else {
    state.topics = []; // start empty by request
  }
  // plan
  const plan = loadJSON(KEY_PLAN, null);
  if(plan){ state.plan = plan; }
  // bg lists
  const bg = loadJSON(KEY_BG, null);
  if(bg){ state.bgLists = bg; } else {
    state.bgLists.login = DEFAULT_BGS[0].slice();
    state.bgLists.dash = DEFAULT_BGS[1].slice();
    saveJSON(KEY_BG, state.bgLists);
  }
}
initDefaults();

/* ==========================
   Background rendering + daily slideshow
   - daily rotation chooses index = (dayNumber % N)
   - manual next/prev allowed
   - images per page type (login vs dashboard)
   ========================== */
const bgRoot = $('bg');
function renderBackgrounds(){
  // clear existing images
  bgRoot.querySelectorAll('img.bg-img').forEach(n=>n.remove());
  const list = (state.pageType === 'login') ? state.bgLists.login : state.bgLists.dash;
  if(!list || list.length===0) return;
  // choose index: if manual pageBgIndex set, use it; else choose based on date
  const today = new Date();
  const dayIndex = Math.floor( (today - new Date(today.getFullYear(),0,1)) / (1000*60*60*24) );
  const idx = (typeof state.pageBgIndex === 'number' && state.manualBg) ? state.pageBgIndex : (dayIndex % list.length);
  // create imgs with appropriate opacity
  list.forEach((url,i)=>{
    const img = document.createElement('img');
    img.className = 'bg-img';
    img.src = url;
    img.style.opacity = (i===idx?1:0);
    bgRoot.appendChild(img);
  });
}
renderBackgrounds();

/* manual bg controls */
$('nextBg').addEventListener('click', ()=>{
  const list = (state.pageType === 'login') ? state.bgLists.login : state.bgLists.dash;
  if(!list.length) return;
  state.pageBgIndex = ((state.pageBgIndex||0) + 1) % list.length;
  state.manualBg = true;
  renderBackgrounds();
  renderBgList();
});
$('prevBg').addEventListener('click', ()=>{
  const list = (state.pageType === 'login') ? state.bgLists.login : state.bgLists.dash;
  if(!list.length) return;
  state.pageBgIndex = ((state.pageBgIndex||0) - 1 + list.length) % list.length;
  state.manualBg = true;
  renderBackgrounds();
  renderBgList();
});

/* Add background URL */
$('addBg').addEventListener('click', ()=>{
  const url = prompt('Paste image URL to add (direct image link recommended). Leave blank to cancel.');
  if(!url) return;
  if(state.pageType === 'login') state.bgLists.login.push(url); else state.bgLists.dash.push(url);
  saveJSON(KEY_BG, state.bgLists);
  renderBgList(); renderBackgrounds();
});

/* render bg list in UI */
function renderBgList(){
  const wrap = $('bgList'); wrap.innerHTML = '';
  const list = (state.pageType === 'login') ? state.bgLists.login : state.bgLists.dash;
  list.forEach((u,i)=>{
    const div = document.createElement('div'); div.style.display='flex';div.style.alignItems='center';div.style.gap='8px';div.style.marginTop='8px';
    const img = document.createElement('img'); img.src=u; img.style.width='72px'; img.style.height='48px'; img.style.objectFit='cover'; img.style.borderRadius='6px';
    const t = document.createElement('div'); t.style.flex='1'; t.style.fontSize='13px'; t.textContent = (u.length>60?u.slice(0,58)+'…':u);
    const del = document.createElement('button'); del.className='btn ghost'; del.textContent='Delete';
    del.addEventListener('click', ()=>{ if(confirm('Remove this image?')){ list.splice(i,1); saveJSON(KEY_BG,state.bgLists); renderBgList(); renderBackgrounds(); } });
    div.appendChild(img); div.appendChild(t); div.appendChild(del); wrap.appendChild(div);
  });
  // preview
  const preview = $('bgPreview'); preview.innerHTML='';
  if(list.length){
    const img = document.createElement('img'); img.src = list[(state.pageBgIndex||0) % list.length]; preview.appendChild(img);
  } else {
    preview.textContent = 'No images yet';
  }
}

/* ==========================
   Login / Sign up (local)
   - Sign up saves profile in localStorage (KEY_USER)
   - Sign in checks stored profile
   - Demo loads sample data
   - Guest creates temporary session (stored but may be anonymous)
   ========================== */
function showLogin(){ $('loginView').style.display='block'; $('dashView').style.display='none'; state.pageType='login'; renderBackgrounds(); renderBgList(); $('logoutBtn').style.display='none'; }
function showDash(){ $('loginView').style.display='none'; $('dashView').style.display='block'; state.pageType='dash'; renderBackgrounds(); renderBgList(); $('logoutBtn').style.display='inline-block'; }

function loadUserToUI(){
  if(!state.user) return;
  $('welcomeName').textContent = state.user.name || 'Student';
  $('welcomeDept').textContent = state.user.department || '';
  $('userBrief').textContent = `${state.user.name || 'Student'} • ${state.user.department || ''}`;
  $('nameIn').value = state.user.name || '';
  $('emailIn').value = state.user.email || '';
  $('deptIn').value = state.user.department || '';
  // set plan
  $('startDate').value = state.plan.startDate || '';
  $('durationDays').value = state.plan.durationDays || 30;
}

/* Sign up */
$('signupBtn').addEventListener('click', ()=>{
  const name = $('nameIn').value.trim() || 'Moses Carson';
  const email = $('emailIn').value.trim() || (`guest_${Date.now()}@local`);
  const dept = $('deptIn').value.trim() || '';
  state.user = { name, email, department:dept, created:Date.now() };
  saveJSON(KEY_USER, state.user);
  // initialize topics & plan if empty
  if(!state.topics || state.topics.length===0) {
    state.topics = []; saveJSON(KEY_TOPICS, state.topics);
  }
  savePlanLocal();
  loadUserToUI();
  renderTopics();
  showDash();
});

/* Sign in */
$('signinBtn').addEventListener('click', ()=>{
  const email = $('emailIn').value.trim();
  const saved = loadJSON(KEY_USER, null);
  if(!saved || (email && saved.email !== email)){
    alert('No local account found with that email. Please Sign up or use Demo / Guest.');
    return;
  }
  state.user = saved;
  state.topics = loadJSON(KEY_TOPICS, state.topics || []);
  state.plan = loadJSON(KEY_PLAN, state.plan || state.plan);
  loadUserToUI(); renderTopics(); showDash();
});

/* Guest */
$('guestBtn').addEventListener('click', ()=>{
  state.user = { name:'Guest', email:`guest_${Date.now()}@local`, department:'', created:Date.now() };
  saveJSON(KEY_USER, state.user);
  if(!state.topics) state.topics = [];
  saveJSON(KEY_TOPICS, state.topics);
  savePlanLocal();
  loadUserToUI(); renderTopics(); showDash();
});

/* Demo */
$('demoBtn').addEventListener('click', ()=>{
  state.user = { name:'Moses Carson', email:'moses.carson@example.com', department:'MLS', created:Date.now() };
  // sample topics
  state.topics = [
    { title:'Introduction to Metabolism', done:false },
    { title:'Glycolysis overview', done:false },
    { title:'TCA cycle essentials', done:false },
    { title:'Lipid digestion & absorption', done:false },
    { title:'Beta-oxidation basics', done:false },
    { title:'Urea cycle summary', done:false },
    { title:'DNA replication basics', done:false },
    { title:'Cardiac cycle & ECG', done:false }
  ];
  state.plan = { startDate: new Date().toISOString().slice(0,10), durationDays:30 };
  saveJSON(KEY_USER, state.user);
  saveJSON(KEY_TOPICS, state.topics);
  saveJSON(KEY_PLAN, state.plan);
  loadUserToUI(); renderTopics(); showDash();
});

/* Logout */
$('logoutBtn').addEventListener('click', ()=>{
  if(confirm('Logout and return to sign-in?')) {
    state.user = null; saveJSON(KEY_USER, null); // keep topics locally though
    showLogin();
  }
});

/* Save plan */
function savePlanLocal(){
  state.plan.startDate = $('startDate').value || null;
  state.plan.durationDays = parseInt($('durationDays').value || 30);
  saveJSON(KEY_PLAN, state.plan);
  updateStats();
}
$('savePlan').addEventListener('click', savePlanLocal);

/* Add topic */
$('addTopic').addEventListener('click', ()=>{
  const t = prompt('Enter topic title (e.g. "Glycolysis - Steps & regulation")');
  if(!t) return;
  state.topics.push({ title:t, done:false });
  saveJSON(KEY_TOPICS, state.topics);
  renderTopics();
});

/* Edit topics (simple reorder / mass edits) */
$('editTopics').addEventListener('click', ()=>{
  if(!state.topics || state.topics.length===0) return alert('No topics to edit.');
  const current = state.topics.map((t,i)=>`${i+1}. ${t.title}`).join('\n');
  const txt = prompt('Edit topics (one per line). Order matters.\n(Current list shown below)\n\n'+current);
  if(!txt) return;
  const lines = txt.split('\n').map(s=>s.trim()).filter(Boolean);
  state.topics = lines.map(l=>({ title:l, done:false }));
  saveJSON(KEY_TOPICS, state.topics);
  renderTopics();
});

/* Render topics UI */
function renderTopics(){
  const list = $('topicsList'); list.innerHTML='';
  if(!state.topics || state.topics.length===0){
    list.innerHTML = '<div class="muted small">No topics yet — add your topics with + Add Topic</div>';
    updateStats(); return;
  }
  state.topics.forEach((t,i)=>{
    const div = document.createElement('div'); div.className='topic';
    const cb = document.createElement('input'); cb.type='checkbox'; cb.checked = !!t.done;
    cb.addEventListener('change', ()=>{
      // when user tries to check, optionally require quiz later; for now just toggle
      t.done = cb.checked;
      saveJSON(KEY_TOPICS, state.topics);
      renderTopics(); // re-render to update styles & stats
    });
    const title = document.createElement('div'); title.className='title'; title.textContent = t.title;
    const actions = document.createElement('div'); actions.className='actions';
    const edit = document.createElement('button'); edit.className='btn ghost small'; edit.textContent='Edit';
    edit.addEventListener('click', ()=>{
      const newT = prompt('Edit topic title', t.title); if(newT){ t.title = newT; saveJSON(KEY_TOPICS,state.topics); renderTopics(); }
    });
    const del = document.createElement('button'); del.className='btn ghost small'; del.textContent='Delete';
    del.addEventListener('click', ()=>{
      if(confirm('Delete this topic?')){ state.topics.splice(i,1); saveJSON(KEY_TOPICS,state.topics); renderTopics(); }
    });
    actions.appendChild(edit); actions.appendChild(del);
    div.appendChild(cb); div.appendChild(title); div.appendChild(actions);
    list.appendChild(div);
  });
  updateStats();
}

/* Update stats & progress */
function updateStats(){
  const total = state.topics.length;
  const completed = state.topics.filter(t=>t.done).length;
  const percent = total === 0 ? 0 : Math.round((completed/total)*100);
  $('percentLarge').textContent = percent + '%';
  $('completedCount').textContent = completed;
  $('remainingCount').textContent = Math.max(total-completed,0);
  $('progressFill').style.width = percent + '%';
  $('progressFill').textContent = percent + '%';
  // compute daily target using plan
  const duration = (state.plan && state.plan.durationDays) ? state.plan.durationDays : 30;
  const totalTopics = total;
  const perDay = Math.max(1, Math.ceil(totalTopics / Math.max(1,duration)));
  $('dailyTarget').textContent = perDay;
}

/* Download & restore */
$('download').addEventListener('click', ()=>{
  const data = { user: state.user, topics: state.topics, plan: state.plan, bg: state.bgLists };
  const blob = new Blob([JSON.stringify(data, null, 2)], {type:'application/json'});
  const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href=url; a.download='study-progress.json'; a.click(); URL.revokeObjectURL(url);
});
$('restore').addEventListener('click', ()=>{
  const inp = document.createElement('input'); inp.type='file'; inp.accept='application/json';
  inp.onchange = async (e) => {
    const f = e.target.files[0]; if(!f) return;
    const txt = await f.text();
    try {
      const d = JSON.parse(txt);
      if(d.user) { state.user = d.user; saveJSON(KEY_USER, state.user); loadUserToUI(); }
      if(d.topics){ state.topics = d.topics; saveJSON(KEY_TOPICS, state.topics); renderTopics(); }
      if(d.plan){ state.plan = d.plan; saveJSON(KEY_PLAN, state.plan); }
      if(d.bg){ state.bgLists = d.bg; saveJSON(KEY_BG, state.bgLists); renderBgList(); renderBackgrounds(); }
      alert('Restored.');
    } catch(err){ alert('Invalid file'); }
  };
  inp.click();
});

/* Reset everything */
$('resetAll').addEventListener('click', ()=>{
  if(!confirm('Reset all local progress and settings? This cannot be undone.')) return;
  localStorage.removeItem(KEY_USER); localStorage.removeItem(KEY_TOPICS); localStorage.removeItem(KEY_PLAN); localStorage.removeItem(KEY_BG);
  // reset in-memory and UI
  state.user = null; state.topics = []; state.plan = {startDate:null,durationDays:30}; state.bgLists = {login:DEFAULT_BGS[0].slice(), dash:DEFAULT_BGS[1].slice()};
  saveJSON(KEY_BG, state.bgLists); renderTopics(); showLogin(); renderBgList(); renderBackgrounds();
});

/* Copy link & deploy guide */
$('copyLink').addEventListener('click', ()=>{ navigator.clipboard.writeText(location.href).then(()=>alert('Link copied')) });
$('deployGuide').addEventListener('click', ()=>{ alert('To deploy: create a GitHub repo, commit this index.html to the repository root, then enable GitHub Pages -> main branch -> / (root).'); });

/* On load: determine which view to show */
function boot(){
  // load persisted
  state.user = loadJSON(KEY_USER, state.user);
  state.topics = loadJSON(KEY_TOPICS, state.topics);
  state.plan = loadJSON(KEY_PLAN, state.plan);
  state.bgLists = loadJSON(KEY_BG, state.bgLists) || state.bgLists;
  // if user exists, show dashboard
  if(state.user){
    loadUserToUI(); renderTopics(); showDash();
  } else {
    showLogin();
  }
  renderBgList(); renderBackgrounds();
}
boot();

/* Helper to update UI if user changes */
function loadUserToUI(){
  if(!state.user) return;
  $('welcomeName').textContent = state.user.name || 'Student';
  $('welcomeDept').textContent = state.user.department || '';
  $('userBrief').textContent = `${state.user.name || 'Student'} • ${state.user.department || ''}`;
  $('nameIn').value = state.user.name || '';
  $('emailIn').value = state.user.email || '';
  $('deptIn').value = state.user.department || '';
  $('startDate').value = state.plan.startDate || '';
  $('durationDays').value = state.plan.durationDays || 30;
  updateStats();
}

/* Render bg list / preview on page switch */
function switchToDash(){ state.pageType='dash'; renderBackgrounds(); renderBgList(); renderTopics(); }
function switchToLogin(){ state.pageType='login'; renderBackgrounds(); renderBgList(); }

document.addEventListener('visibilitychange', ()=>{ if(document.visibilityState==='visible'){ renderBackgrounds(); } });

/* If page switches view we call renderBackgrounds to select appropriate images */
const observer = new MutationObserver(()=>{ /* no-op */ });
observer.observe($('loginView'), { attributes:true, attributeFilter:['style'] });

/* small UX: when changing plan date/duration, update local state */
$('startDate').addEventListener('change', ()=>{ state.plan.startDate = $('startDate').value || null; saveJSON(KEY_PLAN, state.plan); updateStats(); });
$('durationDays').addEventListener('change', ()=>{ state.plan.durationDays = parseInt($('durationDays').value||30); saveJSON(KEY_PLAN, state.plan); updateStats(); });

/* Render initial preview for bgList and topics */
renderBgList();
renderTopics();
updateStats();

/* Ensure background updates when showing login/dash */
const origShowLogin = showLogin;
const origShowDash = showDash;
window.showLogin = function(){ state.pageType='login'; renderBackgrounds(); renderBgList(); origShowLogin(); }
window.showDash = function(){ state.pageType='dash'; renderBackgrounds(); renderBgList(); origShowDash(); }
</script>
</body>
</html>